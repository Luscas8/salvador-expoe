<!DOCTYPE html>
<html>
<head>
    
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    
        <script>
            L_NO_TOUCH = false;
            L_DISABLE_3D = false;
        </script>
    
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
            height: 100vh;
        }
        .controls-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 300px;
        }
        .debug-info {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 300px;
            font-family: monospace;
            font-size: 12px;
        }
        .legend {
            position: fixed;
            bottom: 50px;
            right: 50px;
            width: 180px;
            height: 150px;
            border: 2px solid grey;
            z-index: 9999;
            font-size: 14px;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
    </style>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    
            <meta name="viewport" content="width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
            <style>
                #map {
                    position: relative;
                    width: 100.0%;
                    height: 100.0%;
                    left: 0.0%;
                    top: 0.0%;
                }
                .leaflet-container { font-size: 1rem; }
            </style>
        
    <script src="https://cdn.jsdelivr.net/gh/python-visualization/folium@main/folium/templates/leaflet_heat.min.js"></script>
</head>
<body>
    
    <div class="controls-container">
        <h4>Controles</h4>
        <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="toggleHeatmap" checked>
            <label class="form-check-label" for="toggleHeatmap">Mapa de Calor</label>
        </div>
        <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="toggleMarkers" checked>
            <label class="form-check-label" for="toggleMarkers">Marcadores</label>
        </div>
        <button class="btn btn-primary btn-sm" onclick="atualizarDados()">Atualizar Dados</button>
    </div>

    <div class="debug-info">
        <h5>Debug Info</h5>
        <div id="debugInfo">
            Aguardando dados...
        </div>
    </div>
    
    <div class="legend">
        <div style="font-weight: bold; margin-bottom: 10px; text-align: center;">
            Legenda de Notas
        </div>
        <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <div style="width: 20px; height: 20px; background-color: red; margin-right: 10px; border-radius: 3px;"></div>
            <span>1-4: Vermelho</span>
        </div>
        <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <div style="width: 20px; height: 20px; background-color: orange; margin-right: 10px; border-radius: 3px;"></div>
            <span>5-6: Laranja</span>
        </div>
        <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <div style="width: 20px; height: 20px; background-color: blue; margin-right: 10px; border-radius: 3px;"></div>
            <span>7-8: Azul</span>
        </div>
        <div style="display: flex; align-items: center;">
            <div style="width: 20px; height: 20px; background-color: green; margin-right: 10px; border-radius: 3px;"></div>
            <span>9-10: Verde</span>
        </div>
    </div>
    
    <div id="map"></div>
</body>
<script>
    
    
            var map = L.map('map').setView([-12.9714, -38.5014], 12);

            

        
    
            var tile_layer = L.tileLayer(
                "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                {"attribution": "Data by \u0026copy; \u003ca target=\"_blank\" href=\"http://openstreetmap.org\"\u003eOpenStreetMap\u003c/a\u003e, under \u003ca target=\"_blank\" href=\"http://www.openstreetmap.org/copyright\"\u003eODbL\u003c/a\u003e.", "detectRetina": false, "maxNativeZoom": 18, "maxZoom": 18, "minZoom": 0, "noWrap": false, "opacity": 1, "subdomains": "abc", "tms": false}
            ).addTo(map);
        
    
            var heat_map = L.heatLayer([], {
                "blur": 15,
                "gradient": {"0.0": "red", "0.2": "red", "0.3": "orange", "0.4": "orange", "0.5": "yellow", "0.6": "yellow", "0.7": "blue", "0.8": "blue", "0.9": "green", "1.0": "green"},
                "maxOpacity": 0.9,
                "maxZoom": 18,
                "minOpacity": 0.6,
                "radius": 20
            }).addTo(map);
        
    
            // Array para armazenar os marcadores
            var marcadores = [];
            var showHeatmap = true;
            var showMarkers = true;

            // Função para atualizar o debug info
            function updateDebugInfo(info) {
                document.getElementById('debugInfo').innerHTML = `
                    <pre>${JSON.stringify(info, null, 2)}</pre>
                `;
            }

            // Função para atualizar dados
            function atualizarDados() {
                console.log("Iniciando atualização de dados...");
                updateDebugInfo({status: "Carregando dados..."});
                
                fetch('/mapa-calor-dados/')
                    .then(function(response) {
                        console.log("Resposta recebida:", response.status);
                        return response.json();
                    })
                    .then(function(data) {
                        console.log("Dados atualizados:", data);
                        updateDebugInfo(data);
                        
                        // Atualizar heatmap
                        if (data.data && data.data.length > 0) {
                            heat_map.setLatLngs(data.data);
                            if (showHeatmap) {
                                map.addLayer(heat_map);
                            }
                        }
                        
                        // Remover marcadores antigos
                        marcadores.forEach(function(marcador) {
                            map.removeLayer(marcador);
                        });
                        marcadores = [];
                        
                        // Adicionar novos marcadores
                        if (data.marcadores && data.marcadores.length > 0) {
                            data.marcadores.forEach(function(m) {
                                var marcador = L.circleMarker([m.lat, m.lng], {
                                    radius: 8,
                                    color: m.cor,
                                    fill: true,
                                    fillColor: m.cor,
                                    fillOpacity: 0.7,
                                    weight: 3
                                });
                                
                                marcador.bindPopup(
                                    '<div style="font-family: Arial; font-size: 12px;">' +
                                    '<b>' + m.nome + '</b><br>' +
                                    'Nota média: ' + m.media.toFixed(1) +
                                    '</div>'
                                );
                                
                                if (showMarkers) {
                                    marcador.addTo(map);
                                }
                                marcadores.push(marcador);
                            });
                        }
                    })
                    .catch(function(error) {
                        console.error('Erro ao atualizar dados:', error);
                        updateDebugInfo({error: error.toString()});
                    });
            }

            // Controles de visualização
            document.getElementById('toggleHeatmap').addEventListener('change', function() {
                showHeatmap = this.checked;
                if (showHeatmap) {
                    map.addLayer(heat_map);
                } else {
                    map.removeLayer(heat_map);
                }
            });

            document.getElementById('toggleMarkers').addEventListener('change', function() {
                showMarkers = this.checked;
                marcadores.forEach(function(marcador) {
                    if (showMarkers) {
                        marcador.addTo(map);
                    } else {
                        map.removeLayer(marcador);
                    }
                });
            });

            // Atualizar dados a cada 5 segundos
            setInterval(atualizarDados, 5000);

            // Carregar dados iniciais
            atualizarDados();
        
</script>
</html>