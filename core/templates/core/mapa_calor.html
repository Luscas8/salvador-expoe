{% extends 'base.html' %}
{% load static %}

{% block title %}Mapa de Calor - Avaliação de Bairros{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.css">
<style>
    .map-container {
        position: relative;
        height: calc(100vh - 150px);
        margin-bottom: 20px;
    }
    #map {
        height: 100%;
        width: 100%;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .legend {
        position: fixed;
        bottom: 50px;
        right: 50px;
        width: 200px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        font-family: Arial, sans-serif;
    }
    
    .legend-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
        text-align: center;
        font-size: 14px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        font-size: 12px;
    }
    
    .legend-color {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        border-radius: 4px;
        border: 1px solid #ddd;
    }
    
    .legend-text {
        color: #666;
    }
    .controls-panel {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        width: 250px;
    }
    .stats-panel {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .filter-slider {
        margin: 20px 0;
    }
    .bairro-popup {
        font-size: 14px;
        line-height: 1.4;
    }
    .bairro-popup h5 {
        margin: 0 0 10px 0;
        color: #2c3e50;
    }
    .stat-card {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 10px;
    }
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
    }
    .stat-label {
        color: #6c757d;
        font-size: 14px;
    }
    .legend span {
        margin-right: 10px;
    }
    .control-group {
        margin-bottom: 15px;
    }
    
    .control-label {
        display: block;
        margin-bottom: 5px;
        font-size: 12px;
        color: #666;
    }
    
    .control-slider {
        width: 100%;
        margin: 10px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-panel">
                <h4 class="mb-4">Estatísticas Gerais</h4>
                <div class="row">
                    <div class="col-6 mb-3">
                        <div class="stat-card">
                            <div class="stat-value" id="total-bairros">{{ total_bairros }}</div>
                            <div class="stat-label">Bairros Avaliados</div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="stat-card">
                            <div class="stat-value" id="media-geral">{{ media_geral|floatformat:1 }}</div>
                            <div class="stat-label">Média Geral</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card">
                            <div class="stat-value" id="total-avaliacoes">{{ total_avaliacoes }}</div>
                            <div class="stat-label">Total de Avaliações</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card">
                            <div class="stat-value" id="melhor-bairro-nota">{{ melhor_bairro.media|floatformat:1 }}</div>
                            <div class="stat-label">Melhor Avaliação</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="stats-panel">
                <h4 class="mb-3">Top 5 Bairros</h4>
                <div id="top-bairros-list">
                    {% for bairro in top_bairros %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>{{ bairro.nome }}</span>
                        <span class="badge bg-primary">{{ bairro.media|floatformat:1 }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="map-container">
                <div id="map"></div>
                <div class="controls-panel">
                    <h5 style="margin-bottom: 15px;">Controles do Mapa</h5>
                    <div class="control-group">
                        <label class="control-label">Intensidade do Calor</label>
                        <input type="range" class="control-slider" id="intensity-slider" min="0" max="100" value="70">
                    </div>
                    <div class="control-group">
                        <label class="control-label">Raio do Calor</label>
                        <input type="range" class="control-slider" id="radius-slider" min="5" max="30" value="15">
                    </div>
                    <div class="control-group">
                        <label class="control-label">Blur do Calor</label>
                        <input type="range" class="control-slider" id="blur-slider" min="0" max="20" value="10">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="toggle-heatmap" checked>
                        <label class="form-check-label" for="toggle-heatmap">Mostrar Mapa de Calor</label>
                    </div>
                </div>
            </div>
            <div class="legend">
                <div class="legend-title">Distribuição das Avaliações</div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ff0000;"></div>
                    <span class="legend-text">Ruim (1-2): Avaliação Baixa</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ff7f00;"></div>
                    <span class="legend-text">Regular (3-4): Avaliação Média-Baixa</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ffff00;"></div>
                    <span class="legend-text">Bom (5-6): Avaliação Média</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #00ff00;"></div>
                    <span class="legend-text">Muito Bom (7-8): Avaliação Boa</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #0000ff;"></div>
                    <span class="legend-text">Excelente (9-10): Avaliação Excelente</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<script>
    // Inicializar o mapa
    var map = L.map('map').setView({{ centro_mapa|safe }}, 12);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Configurar o mapa de calor
    var heatData = {{ dados_heatmap|safe }};
    var heatLayer = L.heatLayer(heatData, {
        radius: 40,
        blur: 35,
        maxOpacity: 0.7,
        minOpacity: 0.2,
        gradient: {
            0.0: '#ff0000',  // Vermelho para notas 1-3
            0.3: '#ff7f00',  // Laranja para notas 4-5
            0.5: '#ffff00',  // Amarelo para notas 6-7
            0.7: '#00ff00',  // Verde para notas 8-9
            1.0: '#0000ff'   // Azul para nota 10
        }
    }).addTo(map);
    
    // Array para armazenar os marcadores
    var marcadores = [];

    // Função para atualizar dados
    function atualizarDados() {
        fetch('/mapa-calor-dados/')
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                console.log("Dados atualizados:", data);
                
                // Atualizar heatmap
                if (data.data && data.data.length > 0) {
                    heatLayer.setLatLngs(data.data);
                }
                
                // Remover marcadores antigos
                marcadores.forEach(function(marcador) {
                    map.removeLayer(marcador);
                });
                marcadores = [];
                
                // Adicionar novos marcadores
                if (data.marcadores && data.marcadores.length > 0) {
                    data.marcadores.forEach(function(m) {
                        var marcador = L.circleMarker([m.lat, m.lng], {
                            radius: 8,
                            color: m.cor,
                            fill: true,
                            fillColor: m.cor,
                            fillOpacity: 0.7,
                            weight: 3
                        });
                        
                        marcador.bindPopup(
                            '<div style="font-family: Arial; font-size: 12px;">' +
                            '<b>' + m.nome + '</b><br>' +
                            'Nota média: ' + m.media.toFixed(1) +
                            '</div>'
                        );
                        
                        marcador.addTo(map);
                        marcadores.push(marcador);
                    });
                }
                
                // Atualizar estatísticas
                if (data.stats) {
                    document.getElementById('total-bairros').textContent = data.stats.total_bairros;
                    document.getElementById('total-avaliacoes').textContent = data.stats.total_avaliacoes;
                    document.getElementById('media-geral').textContent = data.stats.media_geral.toFixed(1);
                    document.getElementById('melhor-bairro-nota').textContent = data.stats.melhor_nota.toFixed(1);
                    
                    // Atualizar top 5 bairros
                    var topBairrosList = document.getElementById('top-bairros-list');
                    if (data.stats.top_bairros) {
                        topBairrosList.innerHTML = data.stats.top_bairros.map(function(bairro) {
                            return '<div class="d-flex justify-content-between align-items-center mb-2">' +
                                '<span>' + bairro.nome + '</span>' +
                                '<span class="badge bg-primary">' + bairro.media.toFixed(1) + '</span>' +
                                '</div>';
                        }).join('');
                    }
                }
            })
            .catch(function(error) {
                console.error('Erro ao atualizar dados:', error);
            });
    }

    // Atualizar dados a cada 5 segundos
    setInterval(atualizarDados, 5000);

    // Controles do mapa de calor
    const intensitySlider = document.getElementById('intensity-slider');
    const radiusSlider = document.getElementById('radius-slider');
    const blurSlider = document.getElementById('blur-slider');
    const toggleHeatmap = document.getElementById('toggle-heatmap');

    function updateHeatmap() {
        if (heatLayer) {
            map.removeLayer(heatLayer);
        }
        
        // Usar os dados atualizados do heatmap
        var currentData = heatLayer.getLatLngs();
        
        heatLayer = L.heatLayer(currentData, {
            radius: 40,
            blur: 35,
            maxOpacity: parseInt(intensitySlider.value) / 100,
            minOpacity: (parseInt(intensitySlider.value) / 100) * 0.6,
            gradient: {
                0.0: '#ff0000',  // Vermelho para notas 1-3
                0.3: '#ff7f00',  // Laranja para notas 4-5
                0.5: '#ffff00',  // Amarelo para notas 6-7
                0.7: '#00ff00',  // Verde para notas 8-9
                1.0: '#0000ff'   // Azul para nota 10
            }
        });
        
        if (toggleHeatmap.checked) {
            heatLayer.addTo(map);
        }
    }

    intensitySlider.addEventListener('input', updateHeatmap);
    radiusSlider.addEventListener('input', updateHeatmap);
    blurSlider.addEventListener('input', updateHeatmap);
    toggleHeatmap.addEventListener('change', function() {
        if (this.checked) {
            heatLayer.addTo(map);
        } else {
            map.removeLayer(heatLayer);
        }
    });

    // Carregar dados iniciais
    atualizarDados();
</script>
{% endblock %} 